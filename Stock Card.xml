<?xml version="1.0" encoding="UTF-8"?>
<h:html xmlns:h="http://www.w3.org/1999/xhtml"
        xmlns:orx="http://openrosa.org/jr/xforms"
        xmlns="http://www.w3.org/2002/xforms"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:jr="http://openrosa.org/javarosa">

  <h:head>
    <h:title>Stock Card</h:title>
    <model>
      <instance>
        <data xmlns:jrm="http://dev.commcarehq.org/jr/xforms"
              xmlns="http://openrosa.org/formdesigner/D48F4F44-56D1-49AA-AA9C-8EBD8B199FAE"
              uiVersion="1" version="1" name="Stock Card">
          <transaction_type/>

          <units_added/>
          <expiry/>

          <disbursement_location/>
          <units_disbursed/>

          <adjustment_direction/>
          <units_adjusted/>

          <loss_ask />
          <reason_for_loss />

          <!-- CommTrack -->
          <transaction_magnitude/>

          <receiving>
            <transfer xmlns="http://commcarehq.org/ledger/v1" dest="" date="" section-id="stock">
              <entry id="" quantity=""/>
            </transfer>
          </receiving>

          <disbursing>
            <transfer xmlns="http://commcarehq.org/ledger/v1" src="" date="" section-id="stock">
              <entry id="" quantity=""/>
            </transfer>
          </disbursing>

          <aggregate-monthly>
            <transfer xmlns="http://commcarehq.org/ledger/v1" dest="" date="" section-id="">
              <entry id="" quantity=""/>
            </transfer>
          </aggregate-monthly>
          <!-- /CommTrack -->

        </data>

      </instance>
      <instance id="ledger" src="jr://instance/ledgerdb" />

      <bind nodeset="/data/transaction_type" required="true()"/>

      <bind nodeset="/data/units_added" type="xsd:int" relevant="/data/transaction_type = 'entry'" required="true()"/>
      <bind nodeset="/data/expiry" type="xsd:date" relevant="/data/transaction_type = 'entry'" required="true()"/>

      <bind nodeset="/data/disbursement_location" relevant="/data/transaction_type = 'disbursement'" required="true()"/>
      <bind nodeset="/data/units_disbursed" type="xsd:int" relevant="/data/transaction_type = 'disbursement'" required="true()"/>

      <bind nodeset="/data/adjustment_direction" relevant="/data/transaction_type = 'adjustment'" required="true()"/>
      <bind nodeset="/data/units_adjusted" type="xsd:int" relevant="/data/transaction_type = 'adjustment'" required="true()"/>

      <bind nodeset="/data/loss_ask" relevant="/data/adjustment_direction = 'negative'" required="true()" />
      <bind nodeset="/data/reason_for_loss" relevant="/data/loss_ask = 'yes'" required="true()" />

      <!-- CommTrack -->
      <bind nodeset="/data/receiving/transfer/@date" calculate="/data/meta/timeEnd"/>
      <bind nodeset="/data/disbursing/transfer/@date" calculate="/data/meta/timeEnd"/>
      <bind nodeset="/data/aggregate-monthly/transfer/@date" calculate="/data/meta/timeEnd"/>

      <bind nodeset="/data/receiving/transfer/entry/@id" calculate="instance('commcaresession')/session/data/product_id"/>
      <bind nodeset="/data/disbursing/transfer/entry/@id" calculate="instance('commcaresession')/session/data/product_id"/>
      <bind nodeset="/data/aggregate-monthly/transfer/entry/@id" calculate="instance('commcaresession')/session/data/product_id"/>

      <!-- Is the value being added or subtracted? -->
      <bind nodeset="/data/receiving"
            relevant="(/data/transaction_type = 'entry') or
                      (/data/transaction_type = 'adjustment' and /data/adjustment_direction = 'positive')"/>
      <bind nodeset="/data/receiving/transfer/@dest" calculate="instance('commcaresession')/session/data/case_id_case_supply-point"/>

      <bind nodeset="/data/disbursing"
            relevant="(/data/transaction_type = 'disbursement') or
                      (/data/transaction_type = 'adjustment' and /data/adjustment_direction = 'negative')"/>
      <bind nodeset="/data/disbursing/transfer/@src" calculate="instance('commcaresession')/session/data/case_id_case_supply-point"/>

      <!-- What is the magnitude of the change? -->
      <bind nodeset="/data/transaction_magnitude"
            calculate="
                if(/data/transaction_type = 'entry', /data/units_added,
                if(/data/transaction_type = 'disbursement', /data/units_disbursed,
                /data/units_adjusted
                ))
            "/>
      <bind nodeset="/data/receiving/transfer/entry/@quantity" calculate="/data/transaction_magnitude"/>
      <bind nodeset="/data/disbursing/transfer/entry/@quantity" calculate="/data/transaction_magnitude"/>
      <bind nodeset="/data/aggregate-monthly/transfer/entry/@quantity" calculate="/data/transaction_magnitude"/>

      <!-- Monthly aggregate info for requisition form -->
      <bind nodeset="/data/aggregate-monthly/transfer/@dest" calculate="instance('commcaresession')/session/data/case_id_case_supply-point"/>
      <bind nodeset="/data/aggregate-monthly/transfer/@section-id"
            calculate="
            if(/data/transaction_type = 'entry', 'entries',
            if(/data/transaction_type = 'disbursement', 'disbursements',
            if(/data/transaction_type = 'adjustment' and /data/adjustment_direction = 'negative',
                if(/data/loss_ask = 'yes', 'losses', 'neg_adjustments'),
            'pos_adjustments'
            )))
            "/>

      <!-- /CommTrack -->

      <itext>
        <translation lang="por">
          <text id="transaction_type-label">
            <value>Tipo do movimento</value>
          </text>
          <text id="transaction_type-entry-label">
            <value>Entrada</value>
          </text>
          <text id="transaction_type-disbursement-label">
            <value>Saida</value>
          </text>
          <text id="transaction_type-adjustment-label">
            <value>Ajuste</value>
          </text>
          <text id="units_added-label">
            <value>Quantidade da entrada:</value>
          </text>
          <text id="expiry-label">
            <value>Validade</value>
          </text>
          <text id="disbursement_location-label">
            <value>Destino do movimento?</value>
          </text>
          <text id="disbursement_location-pharmacy-label">
            <value>Farmácia pública</value>
          </text>
          <text id="disbursement_location-maternity-label">
            <value>Maternidade</value>
          </text>
          <text id="disbursement_location-infirmary-label">
            <value>Enfermaria</value>
          </text>
          <text id="disbursement_location-mobile-label">
            <value>Brigada móvel</value>
          </text>
          <text id="disbursement_location-other_us-label">
            <value>Outra Unidade Sanitária</value>
          </text>
          <text id="units_disbursed-label">
            <value>Quantidade das saidas?</value>
          </text>
          <text id="adjustment_direction-label">
            <value>Tipo do ajuste?</value>
          </text>
          <text id="adjustment_direction-positive-label">
            <value>Positivo</value>
          </text>
          <text id="adjustment_direction-negative-label">
            <value>Negativo</value>
          </text>
          <text id="units_adjusted-label">
            <value>Quantidade do ajuste <output value="if(/data/adjustment_direction = 'positive', 'positivo', 'negativo')"/>?</value>
          </text>
          <text id="loss_ask-label">
            <value> Este ajuste negativo foi uma perda?</value>
          </text>
          <text id="loss_ask-yes-label">
            <value>Sim</value>
          </text>
          <text id="loss_ask-no-label">
            <value>Não</value>
          </text>
          <text id="reason_for_loss-label">
            <value>Qual é a razão para a perda?</value>
          </text>
          <text id="reason_for_loss-expiration-label">
            <value>Expiração</value>
          </text>
          <text id="reason_for_loss-break-label">
            <value>Rompido</value>
          </text>
          <text id="reason_for_loss-misplaced-label">
            <value>Extravio</value>
          </text>
        </translation>
        <translation lang="en" default="">

          <text id="transaction_type-label">
            <value>What type of transaction is this?</value>
          </text>
          <text id="transaction_type-entry-label">
            <value>Entry</value>
          </text>
          <text id="transaction_type-disbursement-label">
            <value>Disbursement</value>
          </text>
          <text id="transaction_type-adjustment-label">
            <value>Adjustment</value>
          </text>

          <text id="units_added-label">
            <value>How many units are being added?</value>
          </text>
          <text id="expiry-label">
            <value>What is the earliest expiration date of the items being added?</value>
          </text>

          <text id="disbursement_location-label">
            <value>What is this being disbursed to?</value>
          </text>
          <text id="disbursement_location-pharmacy-label">
            <value>Pharmacy</value>
          </text>
          <text id="disbursement_location-maternity-label">
            <value>Maternity</value>
          </text>
          <text id="disbursement_location-infirmary-label">
            <value>Enfermaria</value>
          </text>
          <text id="disbursement_location-mobile-label">
            <value>Brigada movel</value>
          </text>
          <text id="disbursement_location-other_us-label">
            <value>Another health center</value>
          </text>
          <text id="units_disbursed-label">
            <value>How many units are being disbursed?</value>
          </text>

          <text id="adjustment_direction-label">
            <value>Is this a positive or negative adjustment?</value>
          </text>
          <text id="adjustment_direction-positive-label">
            <value>Positive</value>
          </text>
          <text id="adjustment_direction-negative-label">
            <value>Negative</value>
          </text>
          <text id="units_adjusted-label">
            <value>How many units are being <output value="if(/data/adjustment_direction = 'positive', 'added', 'deducted')"/>?</value>
          </text>
          <text id="loss_ask-label">
            <value> Is this negative adjustment a loss?</value>
          </text>
          <text id="loss_ask-yes-label">
            <value>Yes</value>
          </text>
          <text id="loss_ask-no-label">
            <value>No</value>
          </text>
          <text id="reason_for_loss-label">
            <value>What is the reason for the loss?</value>
          </text>
          <text id="reason_for_loss-expiration-label">
            <value>Expiration</value>
          </text>
          <text id="reason_for_loss-break-label">
            <value>Broken</value>
          </text>
          <text id="reason_for_loss-misplaced-label">
            <value>Missing</value>
          </text>


        </translation>
      </itext>

    </model>
  </h:head>

  <h:body>

    <select1 ref="/data/transaction_type">
      <label ref="jr:itext('transaction_type-label')"/>
      <item>
        <label ref="jr:itext('transaction_type-entry-label')"/>
        <value>entry</value>
      </item>
      <item>
        <label ref="jr:itext('transaction_type-disbursement-label')"/>
        <value>disbursement</value>
      </item>
      <item>
        <label ref="jr:itext('transaction_type-adjustment-label')"/>
        <value>adjustment</value>
      </item>
    </select1>

    <input ref="/data/units_added">
      <label ref="jr:itext('units_added-label')"/>
    </input>

    <input ref="/data/expiry">
        <label ref="jr:itext('expiry-label')"/>
    </input>

    <select1 ref="/data/disbursement_location">
      <label ref="jr:itext('disbursement_location-label')"/>
      <item>
        <label ref="jr:itext('disbursement_location-pharmacy-label')"/>
        <value>pharmacy</value>
      </item>
      <item>
        <label ref="jr:itext('disbursement_location-maternity-label')"/>
        <value>maternity</value>
      </item>
      <item>
        <label ref="jr:itext('disbursement_location-infirmary-label')"/>
        <value>infirmary</value>
      </item>
      <item>
        <label ref="jr:itext('disbursement_location-mobile-label')"/>
        <value>mobile</value>
      </item>
      <item>
        <label ref="jr:itext('disbursement_location-other_us-label')"/>
        <value>other_us</value>
      </item>
    </select1>

    <input ref="/data/units_disbursed">
      <label ref="jr:itext('units_disbursed-label')"/>
    </input>

    <select1 ref="/data/adjustment_direction">
      <label ref="jr:itext('adjustment_direction-label')"/>
      <item>
        <label ref="jr:itext('adjustment_direction-positive-label')"/>
        <value>positive</value>
      </item>
      <item>
        <label ref="jr:itext('adjustment_direction-negative-label')"/>
        <value>negative</value>
      </item>
    </select1>

    <input ref="/data/units_adjusted">
      <label ref="jr:itext('units_adjusted-label')"/>
    </input>

    <select1 ref="/data/loss_ask">
      <label ref="jr:itext('loss_ask-label')"/>
      <item>
        <label ref="jr:itext('loss_ask-yes-label')"/>
        <value>yes</value>
      </item>
      <item>
        <label ref="jr:itext('loss_ask-no-label')"/>
        <value>no</value>
      </item>
    </select1>
    <select1 ref="/data/reason_for_loss">
      <label ref="jr:itext('reason_for_loss-label')"/>
      <item>
        <label ref="jr:itext('reason_for_loss-expiration-label')"/>
        <value>expiration</value>
      </item>
      <item>
        <label ref="jr:itext('reason_for_loss-break-label')"/>
        <value>break</value>
      </item>
      <item>
        <label ref="jr:itext('reason_for_loss-misplaced-label')"/>
        <value>misplaced</value>
      </item>
    </select1>
  </h:body>
</h:html>
