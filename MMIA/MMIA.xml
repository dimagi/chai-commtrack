<?xml version="1.0" encoding="UTF-8"?>
<h:html xmlns:h="http://www.w3.org/1999/xhtml"
        xmlns:orx="http://openrosa.org/jr/xforms"
        xmlns="http://www.w3.org/2002/xforms"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:jr="http://openrosa.org/javarosa"
        xmlns:vellum="http://commcarehq.org/xforms/vellum">
  <h:head>
    <h:title>MMIA</h:title>
    <model>
      <instance>
        <data xmlns:jrm="http://dev.commcarehq.org/jr/xforms"
              xmlns="http://openrosa.org/formdesigner/09p76gpqh7xto60pz51k1bnxppgs3bu7rsj3xur4"
              uiVersion="1" version="1" name="Confirm MMIA">

          <!-- Confirm MMIA -->
          <calculated_initial_stock/>
          <initial_stock/>

          <calculated_entries/>
          <entries/>

          <calculated_exits/>
          <exits/>

          <calculated_losses/>
          <losses/>

          <calculated_inventory/>
          <inventory/>

          <validity/>

          <!-- Regimens -->
          <adultos_label/>
          <AZT_3TC_NVP/>
          <TDF_3TC_EFV/>
          <AZT_3TC_EFV/>
          <d4T_30_3TC_NVP/>
          <d4T_30_3TC_EFV/>
          <AZT_3TC_LPV_r/>
          <TDF_3TC_LPV_r/>
          <ABC_3TC_LPV_r/>
          <AZT_3TC_ABC/>
          <peds_label/>
          <d4T6_3TC_NVP_DFCBab/>
          <d4T_3TC_LPV_r_baby/>
          <d4T_3TC_ABC_baby/>
          <d4T6_3TC_EFV_2DFCBaby_EFV/>
          <AZT60_3TC_NVP_3DFC/>
          <AZT60_3TC_EFV_2DFC/>
          <AZT_3TC_ABC_ped/>
          <AZT_ddI400_LPV_r/>
          <ABC_3TC_EFV/>
          <types_of_patients/>
          <new_patients/>
          <maintained_patients/>
          <altered_patients/>
          <ptv/>
          <ppe/>
          <total_months/>
          <total_patients/>

          <!-- CommTrack -->

          <!-- Transfers to reset monthly aggregates -->
          <monthly-initial>
            <transfer xmlns="http://commcarehq.org/ledger/v1" src="" date="" section-id="monthly-initial">
              <entry id="" quantity="0"/>
            </transfer>
          </monthly-initial>
          <entries>
            <transfer xmlns="http://commcarehq.org/ledger/v1" src="" date="" section-id="entries">
              <entry id="" quantity="0"/>
            </transfer>
          </entries>
          <disbursements>
            <transfer xmlns="http://commcarehq.org/ledger/v1" src="" date="" section-id="disbursements">
              <entry id="" quantity="0"/>
            </transfer>
          </disbursements>
          <neg_adjustments>
            <transfer xmlns="http://commcarehq.org/ledger/v1" src="" date="" section-id="neg_adjustments">
              <entry id="" quantity="0"/>
            </transfer>
          </neg_adjustments>
          <pos_adjustments>
            <transfer xmlns="http://commcarehq.org/ledger/v1" src="" date="" section-id="pos_adjustments">
              <entry id="" quantity="0"/>
            </transfer>
          </pos_adjustments>

          <!-- /CommTrack -->
        </data>
      </instance>
      <instance id="ledger" src="jr://instance/ledgerdb" />
      <!-- Looks like:
          <ledgerdb>
            <ledger entity-id="">
              <section section-id="">
                <entry id="" exponent=""/>
              </section>
            </ledger>
          </ledgerdb>

          <bind nodeset="/data/products/old_stock_total"
                calculate="coalesce(
                  instance('ledger')/ledgerdb/
                    ledger[@entity-id=instance('commcaresession')/session/data/case_id]/
                    section[@section-id='stock']/
                    entry[@id=instance('commcaresession')/session/data/product_id],
                  0)" />
      -->

      <!-- TODO - prepopulate these fields from the ledger data -->
      <!-- then reset the fields to zero -->

      <!-- Confirm MMIA -->
      <!-- TODO make it two setvalues and a bind -->
      <setvalue event="xforms-ready" ref="/data/calculated_initial_stock"
        value="coalesce(
          instance('ledger')/ledgerdb/
          ledger[@entity-id=instance('commcaresession')/session/data/case_id_case_supply-point]/
          section[@section-id='monthly-initial']/
          entry[@id=instance('commcaresession')/session/data/product_id],
        0)" />
      <setvalue event="xforms-ready" ref="/data/initial_stock" value="/data/calculated_initial_stock"/>
      <bind nodeset="/data/initial_stock" type="xsd:int" required="true()"/>

      <setvalue event="xforms-ready" ref="/data/calculated_entries"
        value="coalesce(
          instance('ledger')/ledgerdb/
          ledger[@entity-id=instance('commcaresession')/session/data/case_id_case_supply-point]/
          section[@section-id='entries']/
          entry[@id=instance('commcaresession')/session/data/product_id],
        0)" />
      <setvalue event="xforms-ready" ref="/data/entries" value="/data/calculated_entries"/>
      <bind nodeset="/data/entries" type="xsd:int" required="true()"/>

      <setvalue event="xforms-ready" ref="/data/calculated_exits"
        value="coalesce(
          instance('ledger')/ledgerdb/
          ledger[@entity-id=instance('commcaresession')/session/data/case_id_case_supply-point]/
          section[@section-id='exits']/
          entry[@id=instance('commcaresession')/session/data/product_id],
        0)" />
      <!-- Uncomment the next line to prepopulate the exits field -->
      <!-- <setvalue event="xforms-ready" ref="/data/exits" value="/data/calculated_exits"/> -->
      <bind nodeset="/data/exits" type="xsd:int"/>

      <setvalue event="xforms-ready" ref="/data/calculated_losses"
        value="coalesce(
          instance('ledger')/ledgerdb/
          ledger[@entity-id=instance('commcaresession')/session/data/case_id_case_supply-point]/
          section[@section-id='losses']/
          entry[@id=instance('commcaresession')/session/data/product_id],
        0)" />
      <setvalue event="xforms-ready" ref="/data/losses" value="/data/calculated_losses"/>
      <bind nodeset="/data/losses" type="xsd:int" required="true()"/>

      <setvalue event="xforms-ready" ref="/data/calculated_inventory"
        value="coalesce(
          instance('ledger')/ledgerdb/
          ledger[@entity-id=instance('commcaresession')/session/data/case_id_case_supply-point]/
          section[@section-id='inventory']/
          entry[@id=instance('commcaresession')/session/data/product_id],
        0)" />
      <setvalue event="xforms-ready" ref="/data/inventory" value="/data/calculated_inventory"/>
      <bind nodeset="/data/inventory" type="xsd:int" required="true()"/>

      <bind nodeset="/data/validity" type="xsd:date"
            relevant="/data/inventory != 0" required="true()"/>

      <!-- [> Regimens <] -->
      <!-- <bind nodeset="/data/adultos_label"/> -->
      <!-- <bind nodeset="/data/AZT_3TC_NVP" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/TDF_3TC_EFV" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/AZT_3TC_EFV" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/d4T_30_3TC_NVP" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/d4T_30_3TC_EFV" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/AZT_3TC_LPV_r" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/TDF_3TC_LPV_r" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/ABC_3TC_LPV_r" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/AZT_3TC_ABC" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/peds_label"/> -->
      <!-- <bind nodeset="/data/d4T6_3TC_NVP_DFCBab" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/d4T_3TC_LPV_r_baby" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/d4T_3TC_ABC_baby" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/d4T6_3TC_EFV_2DFCBaby_EFV" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/AZT60_3TC_NVP_3DFC" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/AZT60_3TC_EFV_2DFC" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/AZT_3TC_ABC_ped" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/AZT_ddI400_LPV_r" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/ABC_3TC_EFV" type="xsd:int" required="true()"/> -->
      <!-- <bind nodeset="/data/types_of_patients"/> -->
      <!-- <bind nodeset="/data/new_patients" type="xsd:int"/> -->
      <!-- <bind nodeset="/data/maintained_patients" type="xsd:int"/> -->
      <!-- <bind nodeset="/data/altered_patients" type="xsd:int"/> -->
      <!-- <bind nodeset="/data/ptv" type="xsd:int"/> -->
      <!-- <bind nodeset="/data/ppe" type="xsd:int"/> -->
      <!-- <bind nodeset="/data/total_months" type="xsd:int"/> -->
      <!-- <bind nodeset="/data/total_patients" type="xsd:int"/> -->

      <!-- CommTrack -->
      <!-- /CommTrack -->

      <itext>

        <translation lang="en" default="">

          <!-- Confirm MMIA -->
          <text id="initial_stock-label">
            <value>Initial Stock:</value>
          </text>
          <text id="entries-label">
            <value>Entries:</value>
          </text>
          <text id="exits-label">
            <value>Exits real:</value>
          </text>
          <text id="losses-label">
            <value>Losses and Adjustments:</value>
          </text>
          <text id="inventory-label">
            <value>Inventory:</value>
          </text>
          <text id="validity-label">
            <value>Expiration:</value>
          </text>

          <!-- Regimens -->
          <text id="adultos_label-label">
            <value>Total people on each therapeutic regimen: Adults</value>
          </text>
          <text id="AZT_3TC_NVP-label">
            <value>AZT+3TC+NVP</value>
          </text>
          <text id="TDF_3TC_EFV-label">
            <value>TDF+3TC+EFV</value>
          </text>
          <text id="AZT_3TC_EFV-label">
            <value>AZT+3TC+EFV</value>
          </text>
          <text id="d4T_30_3TC_NVP-label">
            <value>d4T 30+3TC+NVP</value>
          </text>
          <text id="d4T_30_3TC_EFV-label">
            <value>d4T 30+3TC+EFV</value>
          </text>
          <text id="AZT_3TC_LPV_r-label">
            <value>AZT+3TC+LPV/r</value>
          </text>
          <text id="TDF_3TC_LPV_r-label">
            <value>TDF+3TC+LPV/r</value>
          </text>
          <text id="ABC_3TC_LPV_r-label">
            <value>ABC+3TC+LPV/r</value>
          </text>
          <text id="AZT_3TC_ABC-label">
            <value>AZT300+3TC+ABC</value>
          </text>
          <text id="peds_label-label">
            <value>Total people on each therapeutic regimen: Pediatrics</value>
          </text>
          <text id="d4T6_3TC_NVP_DFCBab-label">
            <value>d4T+3TC+NVP (3DFC Baby)</value>
          </text>
          <text id="d4T_3TC_LPV_r_baby-label">
            <value>d4T+3TC+LPV/r (2DFC Baby +LPV/r)</value>
          </text>
          <text id="d4T_3TC_ABC_baby-label">
            <value>d4T+3TC+ABC (2DFC Baby +ABC)</value>
          </text>
          <text id="d4T6_3TC_EFV_2DFCBaby_EFV-label">
            <value>d4T 6+3TC+EFV (2DFC Baby + EFV)</value>
          </text>
          <text id="AZT60_3TC_NVP_3DFC-label">
            <value>AZT60+3TC+NVP (3DFC)</value>
          </text>
          <text id="AZT60_3TC_EFV_2DFC-label">
            <value>AZT 60+3TC+EFV (2DFC + EFV)</value>
          </text>
          <text id="AZT_3TC_ABC_ped-label">
            <value>AZT+3TC+ABC (2DFC +ABC)</value>
          </text>
          <text id="AZT_ddI400_LPV_r-label">
            <value>ABC+3TC+LPV/r</value>
          </text>
          <text id="ABC_3TC_EFV-label">
            <value>ABC+3TC+EFV</value>
          </text>
          <text id="types_of_patients-label">
            <value>Types of patients</value>
          </text>
          <text id="new_patients-label">
            <value>New</value>
          </text>
          <text id="maintained_patients-label">
            <value>Matained</value>
          </text>
          <text id="altered_patients-label">
            <value>Altered</value>
          </text>
          <text id="ptv-label">
            <value>PTV</value>
          </text>
          <text id="ppe-label">
            <value>PPE</value>
          </text>
          <text id="total_months-label">
            <value>Total months of medicine available</value>
          </text>
          <text id="total_patients-label">
            <value>Total patients on TARV in US</value>
          </text>

        </translation>

        <translation lang="por">

          <!-- Confirm MMIA -->
          <text id="initial_stock-label">
            <value>Saldo Inicial</value>
          </text>
          <text id="entries-label">
            <value>Entradas:</value>
          </text>
          <text id="exits-label">
            <value>Saidas reais:</value>
          </text>
          <text id="losses-label">
            <value>Perdas e ajustes:</value>
          </text>
          <text id="inventory-label">
            <value>Inventario</value>
          </text>
          <text id="validity-label">
            <value>Validade:</value>
          </text>

          <!-- Regimens -->
          <text id="adultos_label-label">
            <value>Total doentes em regimes terapeuticos: Adultos</value>
          </text>
          <text id="AZT_3TC_NVP-label">
            <value>AZT+3TC+NVP</value>
          </text>
          <text id="TDF_3TC_EFV-label">
            <value>TDF+3TC+EFV</value>
          </text>
          <text id="AZT_3TC_EFV-label">
            <value>AZT+3TC+EFV</value>
          </text>
          <text id="d4T_30_3TC_NVP-label">
            <value>d4T 30+3TC+NVP</value>
          </text>
          <text id="d4T_30_3TC_EFV-label">
            <value>d4T 30+3TC+EFV</value>
          </text>
          <text id="AZT_3TC_LPV_r-label">
            <value>AZT+3TC+LPV/r</value>
          </text>
          <text id="TDF_3TC_LPV_r-label">
            <value>TDF+3TC+LPV/r</value>
          </text>
          <text id="ABC_3TC_LPV_r-label">
            <value>ABC+3TC+LPV/r</value>
          </text>
          <text id="AZT_3TC_ABC-label">
            <value>AZT300+3TC+ABC</value>
          </text>
          <text id="peds_label-label">
            <value>Total doentes em regimes terapeuticos: Pediatricos</value>
          </text>
          <text id="d4T6_3TC_NVP_DFCBab-label">
            <value>d4T+3TC+NVP (3DFC Baby)</value>
          </text>
          <text id="d4T_3TC_LPV_r_baby-label">
            <value>d4T+3TC+LPV/r (2DFC Baby +LPV/r)</value>
          </text>
          <text id="d4T_3TC_ABC_baby-label">
            <value>d4T+3TC+ABC (2DFC Baby +ABC)</value>
          </text>
          <text id="d4T6_3TC_EFV_2DFCBaby_EFV-label">
            <value>d4T 6+3TC+EFV (2DFC Baby + EFV)</value>
          </text>
          <text id="AZT60_3TC_NVP_3DFC-label">
            <value>AZT60+3TC+NVP (3DFC)</value>
          </text>
          <text id="AZT60_3TC_EFV_2DFC-label">
            <value>AZT 60+3TC+EFV (2DFC + EFV)</value>
          </text>
          <text id="AZT_3TC_ABC_ped-label">
            <value>AZT+3TC+ABC (2DFC +ABC)</value>
          </text>
          <text id="AZT_ddI400_LPV_r-label">
            <value>ABC+3TC+LPV/r</value>
          </text>
          <text id="ABC_3TC_EFV-label">
            <value>ABC+3TC+EFV</value>
          </text>
          <text id="types_of_patients-label">
            <value>Tipos de doents</value>
          </text>
          <text id="new_patients-label">
            <value>Novos</value>
          </text>
          <text id="maintained_patients-label">
            <value>Manuten&#xE7;&#xE3;o</value>
          </text>
          <text id="altered_patients-label">
            <value>Altera&#xE7;&#xE3;o</value>
          </text>
          <text id="ptv-label">
            <value>PTV</value>
          </text>
          <text id="ppe-label">
            <value>PPE</value>
          </text>
          <text id="total_months-label">
            <value>Total de Meses de medicamentos dispensados</value>
          </text>
          <text id="total_patients-label">
            <value>Total de pacientes em TARV na US</value>
          </text>

        </translation>
      </itext>
    </model>
  </h:head>
  <h:body>

    <!-- Confirm MMIA -->
    <input ref="/data/initial_stock">
      <label ref="jr:itext('initial_stock-label')"/>
    </input>
    <input ref="/data/entries">
      <label ref="jr:itext('entries-label')"/>
    </input>
    <!-- Exits -->
    <input ref="/data/exits">
      <label ref="jr:itext('exits-label')"/>
    </input>
    <input ref="/data/losses">
      <label ref="jr:itext('losses-label')"/>
    </input>
    <input ref="/data/inventory">
      <label ref="jr:itext('inventory-label')"/>
    </input>
    <input ref="/data/validity">
      <label ref="jr:itext('validity-label')"/>
    </input>

    <!-- [> Regimens <] -->
    <!-- <trigger ref="/data/adultos_label" appearance="minimal"> -->
      <!-- <label ref="jr:itext('adultos_label-label')"/> -->
    <!-- </trigger> -->
    <!-- <input ref="/data/AZT_3TC_NVP"> -->
      <!-- <label ref="jr:itext('AZT_3TC_NVP-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/TDF_3TC_EFV"> -->
      <!-- <label ref="jr:itext('TDF_3TC_EFV-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/AZT_3TC_EFV"> -->
      <!-- <label ref="jr:itext('AZT_3TC_EFV-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/d4T_30_3TC_NVP"> -->
      <!-- <label ref="jr:itext('d4T_30_3TC_NVP-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/d4T_30_3TC_EFV"> -->
      <!-- <label ref="jr:itext('d4T_30_3TC_EFV-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/AZT_3TC_LPV_r"> -->
      <!-- <label ref="jr:itext('AZT_3TC_LPV_r-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/TDF_3TC_LPV_r"> -->
      <!-- <label ref="jr:itext('TDF_3TC_LPV_r-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/ABC_3TC_LPV_r"> -->
      <!-- <label ref="jr:itext('ABC_3TC_LPV_r-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/AZT_3TC_ABC"> -->
      <!-- <label ref="jr:itext('AZT_3TC_ABC-label')"/> -->
    <!-- </input> -->
    <!-- <trigger ref="/data/peds_label" appearance="minimal"> -->
      <!-- <label ref="jr:itext('peds_label-label')"/> -->
    <!-- </trigger> -->
    <!-- <input ref="/data/d4T6_3TC_NVP_DFCBab"> -->
      <!-- <label ref="jr:itext('d4T6_3TC_NVP_DFCBab-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/d4T_3TC_LPV_r_baby"> -->
      <!-- <label ref="jr:itext('d4T_3TC_LPV_r_baby-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/d4T_3TC_ABC_baby"> -->
      <!-- <label ref="jr:itext('d4T_3TC_ABC_baby-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/d4T6_3TC_EFV_2DFCBaby_EFV"> -->
      <!-- <label ref="jr:itext('d4T6_3TC_EFV_2DFCBaby_EFV-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/AZT60_3TC_NVP_3DFC"> -->
      <!-- <label ref="jr:itext('AZT60_3TC_NVP_3DFC-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/AZT60_3TC_EFV_2DFC"> -->
      <!-- <label ref="jr:itext('AZT60_3TC_EFV_2DFC-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/AZT_3TC_ABC_ped"> -->
      <!-- <label ref="jr:itext('AZT_3TC_ABC_ped-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/AZT_ddI400_LPV_r"> -->
      <!-- <label ref="jr:itext('AZT_ddI400_LPV_r-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/ABC_3TC_EFV"> -->
      <!-- <label ref="jr:itext('ABC_3TC_EFV-label')"/> -->
    <!-- </input> -->
    <!-- <trigger ref="/data/types_of_patients" appearance="minimal"> -->
      <!-- <label ref="jr:itext('types_of_patients-label')"/> -->
    <!-- </trigger> -->
    <!-- <input ref="/data/new_patients"> -->
      <!-- <label ref="jr:itext('new_patients-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/maintained_patients"> -->
      <!-- <label ref="jr:itext('maintained_patients-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/altered_patients"> -->
      <!-- <label ref="jr:itext('altered_patients-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/ptv"> -->
      <!-- <label ref="jr:itext('ptv-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/ppe"> -->
      <!-- <label ref="jr:itext('ppe-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/total_months"> -->
      <!-- <label ref="jr:itext('total_months-label')"/> -->
    <!-- </input> -->
    <!-- <input ref="/data/total_patients"> -->
      <!-- <label ref="jr:itext('total_patients-label')"/> -->
    <!-- </input> -->

  </h:body>
</h:html>
